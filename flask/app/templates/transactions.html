<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  {% if transaction_type_default == 'income' %}
  <title>New Income</title>
  {% elif transaction_type_default == 'expense' %}
  <title>New Expense</title>
  {% else %}
  <title>New Transaction</title>
  {% endif %}
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/new_expense.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* Your custom styles here */
  </style>
</head>

<body>
  <!-- Sidebar (unchanged) -->
  <div class="sidebar">
    <ul>
      <li>
        <a href="{{ url_for('users_profile') }}" title="Profile">
          <span class="icon" id="sidebarProfileIcon">
            <img src="{{ current_user.avatar_url}}"
                 alt="Profile" style="width:40px; height:40px; border-radius:50%;">
          </span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('homepage') }}" title="Home">
          <span class="icon"><i class="bi bi-house-fill"></i></span>
          <span class="text">Home</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('all_transactions') }}" title="All_transaction">
          <span class="icon"><i class="bi bi-clipboard2-fill"></i></span>
          <span class="text">transaction</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('create_transactions', transaction_type='income') }}" title="Income">
          <span class="icon"><i class="bi bi-graph-up"></i></span>
          <span class="text">Income</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('create_transactions', transaction_type='expense') }}" title="Expense">
          <span class="icon"><i class="bi bi-graph-down"></i></span>
          <span class="text">Expense</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('report') }}" title="Report">
          <span class="icon"><i class="bi bi-bar-chart-fill"></i></span>
          <span class="text">Report</span>
        </a>
      </li>
      <div class="bottom">
        <li>
          <a href="{{ url_for('categories_management') }}" title="Categories Management">
            <span class="icon"><i class="bi bi-card-list"></i></span>
            <span class="text">Categories<br>Management</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('users_logout') }}" title="Logout">
            <span class="icon"><i class="bi bi-box-arrow-left"></i></span>
            <span class="text">Logout</span>
          </a>
        </li>
      </div>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if transaction_type_default == 'income' %}
    <h2 class="mb-4" style="font-size: 2rem; font-weight: bold;">New Income</h2>
    {% elif transaction_type_default == 'expense' %}
    <h2 class="mb-4" style="font-size: 2rem; font-weight: bold;">New Expense</h2>
    {% else %}
    <h2 class="mb-4" style="font-size: 2rem; font-weight: bold;">New Transaction</h2>
    {% endif %}

    <form id="transactionForm" method="POST" action="{{ url_for('create_transactions') }}"
      enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="row mb-3">
        <!-- Total (changed to text for formatting) -->
        <div class="col-md-6 mb-3">
          <label for="total" class="form-label">Total</label>
          <input type="text" class="form-control" id="total" name="total" placeholder="Enter amount" required
            oninput="formatNumber(this)">
        </div>
        <!-- Date -->
        <div class="col-md-6 mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" name="date" value="{{ current_date }}" required>
        </div>
      </div>
      <!-- Transaction Type (locked) -->
      <div class="mb-3">
        <label for="transaction_type" class="form-label">Transaction Type</label>
        <select class="form-select" id="transaction_type" name="transaction_type" required {% if transaction_type_default
          %}disabled{% endif %}>
          {% if not transaction_type_default %}
          <option value="" disabled selected>Select Transaction Type</option>
          {% endif %}
          <option value="expense" {% if transaction_type_default=='expense' %}selected{% endif %}>Expense</option>
          <option value="income" {% if transaction_type_default=='income' %}selected{% endif %}>Income</option>
        </select>
        {% if transaction_type_default %}
        <!-- Hidden input to submit the transaction type when preset -->
        <input type="hidden" name="transaction_type" value="{{ transaction_type_default }}">
        {% endif %}
      </div>

      <!-- Category -->
      <div class="mb-3">
        <label for="category" class="form-label">Category</label>
        <select class="selectpicker form-control" id="category" name="category" required data-live-search="true">
          <option value="" disabled selected>Select Category</option>
          {% for cat in categories if cat.transaction_type == transaction_type_default %}
          <option value="{{ cat.category_id }}"
            data-content="<img src='{{ cat.icon_url }}' class='category-icon me-2'> {{ cat.name }}">
            {{ cat.name }}
          </option>
          {% endfor %}
          <option value="create">Create New Category...</option>
        </select>
      </div>
      <!-- Description -->
      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea class="form-control" id="description" name="description" rows="3"
          placeholder="Short note about this transaction"></textarea>
      </div>
      <!-- Entry Method Dropdown -->
      <div class="mb-3">
        <label for="entry_method" class="form-label">Entry Method</label>
        <select class="form-select" id="entry_method" name="entry_method" required>
          <option value="manual" selected>Manual</option>
          <option value="slip">Slip</option>
        </select>
      </div>
      <!-- Scan Container with Preview and OCR Result -->
      <div class="mb-4" id="scanContainer" style="display:none;">
        <label class="form-label">Scan / Slip Image</label>
        <div class="scan-box" id="scanBox">
          <span id="plusSign">+</span>
          <input type="file" name="slip_image" accept="image/*,application/pdf">
        </div>
        <div id="ocrResult"></div>
      </div>
      <!-- Buttons -->
      <button type="submit" class="btn btn-custom">Save</button>
      <a href="{{ url_for('all_transactions', transaction_type='all') }}" class="btn btn-custom">Cancel</a>
    </form>
  </div>

  <!-- Bootstrap and Plugin JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.1/dist/tesseract.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

  <script>
    // Format the total input value with commas
    function formatNumber(input) {
      // Remove any existing commas
      let value = input.value.replace(/,/g, '');
      // Check if it's a valid number
      if (!isNaN(value) && value !== "") {
        // Split into integer and decimal parts (if any)
        let parts = value.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = parts.join('.');
      }
    }

    // Remove commas before form submission
    document.getElementById("transactionForm").addEventListener("submit", function (e) {
      let totalInput = document.getElementById("total");
      totalInput.value = totalInput.value.replace(/,/g, '');
    });

    document.addEventListener("DOMContentLoaded", function () {
      // Initialize Bootstrap Select
      $('#category').selectpicker();

      const entryMethodSelect = document.getElementById("entry_method");
      const scanContainer = document.getElementById("scanContainer");
      const scanBox = document.getElementById("scanBox");
      const plusSign = document.getElementById("plusSign");
      const totalInput = document.getElementById("total");
      const slipInput = document.querySelector('input[name="slip_image"]');
      const ocrResultDiv = document.getElementById("ocrResult");
      const categorySelect = document.getElementById("category");

      // Default setup: "Manual" is selected
      if (entryMethodSelect.value === "manual") {
        scanContainer.style.display = "none";
        totalInput.readOnly = false;
        totalInput.style.backgroundColor = "";
        slipInput.required = false;
      }

      // Redirect to create category if "Create New Category" is selected
      categorySelect.addEventListener("change", function () {
        if (this.value === "create") {
          window.location.href = "{{ url_for('categories') }}";
        }
      });

      entryMethodSelect.addEventListener("change", function () {
        if (entryMethodSelect.value === "slip") {
          scanContainer.style.display = "block";
          totalInput.readOnly = true;
          totalInput.style.backgroundColor = "#e9ecef"; // gray background
          totalInput.value = "";
          slipInput.required = true;
        } else {
          scanContainer.style.display = "none";
          totalInput.readOnly = false;
          totalInput.style.backgroundColor = "";
          slipInput.required = false;
          ocrResultDiv.innerHTML = "";
          if (!document.getElementById("plusSign")) {
            const span = document.createElement("span");
            span.id = "plusSign";
            span.textContent = "+";
            scanBox.insertBefore(span, slipInput);
          }
          Array.from(scanBox.children).forEach(child => {
            if (child.id !== "plusSign" && child.tagName !== "INPUT") {
              child.remove();
            }
          });
        }
      });

      slipInput.addEventListener("change", function (event) {
        // Remove the plus sign if it exists.
        const plus = document.getElementById("plusSign");
        if (plus) {
          plus.remove();
        }
        // Clear previous preview elements and OCR result.
        Array.from(scanBox.children).forEach(child => {
          if (child.tagName !== "INPUT") {
            child.remove();
          }
        });
        ocrResultDiv.innerHTML = "";

        const file = event.target.files[0];
        if (file) {
          scanBox.style.height = "auto";
          if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            img.style.width = "100%";
            img.style.height = "auto";
            img.onload = function () {
              URL.revokeObjectURL(this.src);
            };
            scanBox.appendChild(img);

            // OCR with Tesseract.js (using English and Thai)
            Tesseract.recognize(
              file,
              'eng+tha',
              { langPath: '/tessdata', logger: m => console.log(m) }
            ).then(({ data: { text } }) => {
              console.log("OCR result:", text);
              ocrResultDiv.textContent = "OCR Raw Text: " + text;
              const regex = /([0-9\u0E50-\u0E59]+(?:\.[0-9\u0E50-\u0E59]+)?)/;
              const match = text.match(regex);
              if (match) {
                function thaiToArabic(str) {
                  return str.replace(/[\u0E50-\u0E59]/g, function (ch) {
                    return ch.charCodeAt(0) - 0x0E50;
                  });
                }
                let value = thaiToArabic(match[0]);
                totalInput.value = value;
                console.log("Extracted amount:", value);
              } else {
                totalInput.value = "";
                console.log("No numeric value found in OCR result.");
              }
            }).catch(err => {
              console.error("OCR error:", err);
              totalInput.value = "";
            });
          } else if (file.type === "application/pdf") {
            const p = document.createElement("p");
            p.textContent = "PDF file selected: " + file.name;
            p.style.fontSize = "1rem";
            p.style.textAlign = "center";
            scanBox.appendChild(p);
            totalInput.value = "";
          }
        }
      });
    });
  </script>
</body>

</html>