<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  {% if transaction_type_default == 'income' %}
  <title>New Income</title>
  {% elif transaction_type_default == 'expense' %}
  <title>New Expense</title>
  {% else %}
  <title>New Transaction</title>
  {% endif %}
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/new_expense.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- Google font-->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
  <style>
   .scan-box {
  position: relative;
  min-height: 200px;
}

.preview-image {
  max-width: 100%;
  max-height: 300px;
  object-fit: contain;
  display: none;
  margin: 0 auto;
}

.pdf-preview {
  text-align: center;
  color: #dc3545;
}

#plusSign {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 3rem;
  color: #666;
}
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li>
        <a href="{{ url_for('users_profile') }}" title="Profile">
          <span class="icon" id="sidebarProfileIcon">
            <img src="{{ current_user.avatar_url}}" alt="Profile" style="width:40px; height:40px; border-radius:50%;">
          </span>
          <span class="text">Profile</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('homepage') }}" title="Home">
          <span class="icon"><i class="bi bi-house-fill"></i></span>
          <span class="text">Home</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('all_transactions') }}" title="All_transaction">
          <span class="icon"><i class="bi bi-clipboard2-fill"></i></span>
          <span class="text">Transaction</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('budgets') }}" title="Budgets">
          <span class="icon"><i class="bi bi-credit-card-fill"></i></span>
          <span class="text">Budgets</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('report') }}" title="Charts">
          <span class="icon"><i class="bi bi-bar-chart-line-fill"></i></span>
          <span class="text">Charts</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('Calendar') }}" title="Calendar">
          <span class="icon"><i class="bi bi-calendar-event-fill"></i></span>
          <span class="text">Calendar</span>
        </a>
      </li>
      <div class="bottom">
        <li>
          <a href="{{ url_for('categories_management') }}" title="Categories Management">
            <span class="icon"><i class="bi bi-sliders"></i></span>
            <span class="text">Categories<br>Management</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('users_logout') }}" title="Logout">
            <span class="icon"><i class="bi bi-box-arrow-left"></i></span>
            <span class="text">Logout</span>
          </a>
        </li>
      </div>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% if transaction_type_default == 'income' %}
    <h2 class="mb-4" style="font-size: 2rem; font-weight: bold;">New Income</h2>
    {% elif transaction_type_default == 'expense' %}
    <h2 class="mb-4" style="font-size: 2rem; font-weight: bold;">New Expense</h2>
    {% else %}
    <h2 class="mb-4" style="font-size: 2rem; font-weight: bold;">New Transaction</h2>
    {% endif %}

    <form id="transactionForm" method="POST" action="{{ url_for('create_transactions') }}"
      enctype="multipart/form-data">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
      <div class="row mb-3">
        <!-- Total (changed to text for formatting) -->
        <div class="col-md-6 mb-3">
          <label for="total" class="form-label">Total</label>
          <input type="text" class="form-control" id="total" name="total" placeholder="Enter amount" required
            oninput="formatNumber(this)">
        </div>
        <!-- Date -->
        <div class="col-md-6 mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" name="date" value="{{ current_date }}" required>
        </div>
      </div>
      <!-- Transaction Type (locked) -->
      <div class="mb-3">
        <label for="transaction_type" class="form-label">Transaction Type</label>
        <select class="form-select" id="transaction_type" name="transaction_type" required {% if
          transaction_type_default %}disabled{% endif %}>
          {% if not transaction_type_default %}
          <option value="" disabled selected>Select Transaction Type</option>
          {% endif %}
          <option value="expense" {% if transaction_type_default=='expense' %}selected{% endif %}>Expense</option>
          <option value="income" {% if transaction_type_default=='income' %}selected{% endif %}>Income</option>
        </select>
        {% if transaction_type_default %}
        <!-- Hidden input to submit the transaction type when preset -->
        <input type="hidden" name="transaction_type" value="{{ transaction_type_default }}">
        {% endif %}
      </div>

      <!-- Category -->
      <div class="mb-3">
        <label for="category" class="form-label">Category</label>
        <select class="selectpicker form-control" id="category" name="category" required data-live-search="true">
          <option value="" disabled selected>Select Category</option>
          {% for cat in categories if cat.transaction_type == transaction_type_default %}
          <option value="{{ cat.category_id }}"
            data-content="<img src='{{ cat.icon_url }}' class='category-icon me-2'> {{ cat.name }}">
            {{ cat.name }}
          </option>
          {% endfor %}
          <option value="create">Create New Category...</option>
        </select>
      </div>
      <!-- Description -->
      <div class="mb-3">
        <label for="description" class="form-label">Description</label>
        <textarea class="form-control" id="description" name="description" rows="3"
          placeholder="Short note about this transaction(40 chars)" maxlength="40"></textarea>
      </div>
      <!-- Entry Method Dropdown -->
      <div class="mb-3">
        <label for="entry_method" class="form-label">Entry Method</label>
        <select class="form-select" id="entry_method" name="entry_method" required>
          <option value="manual" selected>Manual</option>
          <option value="slip">Slip</option>
        </select>
      </div>
      <!-- Scan Container with Preview and OCR Result -->
      <div class="mb-4" id="scanContainer" style="display:none;">
        <label class="form-label">Upload Slip/Image</label>
        <div class="scan-box" id="scanBox">
          <input type="file" name="slip_image" id="slipInput" accept="image/*,application/pdf">
          <img id="previewImage" class="preview-image" src="#" alt="Slip preview" style="display: none;">
          <div id="pdfPreview" class="pdf-preview" style="display: none;">
            <i class="bi bi-file-pdf fs-1"></i>
            <span class="pdf-name"></span>
          </div>
          <span id="plusSign">+</span>
        </div>
        <div id="ocrResult" class="mt-2"></div>
      </div>
      <!-- Buttons -->
      <button type="submit" class="btn btn-custom">Save</button>
      <a href="{{ url_for('all_transactions', transaction_type='all') }}" class="btn btn-custom">Cancel</a>
    </form>
  </div>

  <!-- Bootstrap and Plugin JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@v4.0.2/dist/tesseract.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

  <script>
    var csrf_token = "{{ csrf_token() }}";
    // Format the total input value with commas
    function formatNumber(input) {
      // Remove any existing commas
      let value = input.value.replace(/,/g, '');
      // Check if it's a valid number
      if (!isNaN(value) && value !== "") {
        // Split into integer and decimal parts (if any)
        let parts = value.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = parts.join('.');
      }
    }

    // Remove commas before form submission
    document.getElementById("transactionForm").addEventListener("submit", function (e) {
      let totalInput = document.getElementById("total");
      totalInput.value = totalInput.value.replace(/,/g, '');
    });

    document.addEventListener("DOMContentLoaded", function () {
      // Initialize Bootstrap Select
      $('#category').selectpicker();

      const entryMethodSelect = document.getElementById("entry_method");
      const scanContainer = document.getElementById("scanContainer");
      const scanBox = document.getElementById("scanBox");
      const plusSign = document.getElementById("plusSign");
      const totalInput = document.getElementById("total");
      const slipInput = document.querySelector('input[name="slip_image"]');
      const ocrResultDiv = document.getElementById("ocrResult");
      const categorySelect = document.getElementById("category");

      // Default setup: "Manual" is selected
      if (entryMethodSelect.value === "manual") {
        scanContainer.style.display = "none";
        totalInput.readOnly = false;
        totalInput.style.backgroundColor = "";
        slipInput.required = false;
      }

      // Redirect to create category if "Create New Category" is selected
      categorySelect.addEventListener("change", function () {
        if (this.value === "create") {
          window.location.href = "{{ url_for('categories') }}";
        }
      });

      entryMethodSelect.addEventListener("change", function () {
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('pdfPreview').style.display = 'none';
        document.getElementById('plusSign').style.display = 'block';
        if (entryMethodSelect.value === "slip") {
          scanContainer.style.display = "block";
          totalInput.readOnly = true;
          totalInput.style.backgroundColor = "#e9ecef"; // gray background
          totalInput.value = "";
          slipInput.required = true;
        } else {
          scanContainer.style.display = "none";
          totalInput.readOnly = false;
          totalInput.style.backgroundColor = "";
          slipInput.required = false;
          ocrResultDiv.innerHTML = "";
          if (!document.getElementById("plusSign")) {
            const span = document.createElement("span");
            span.id = "plusSign";
            span.textContent = "+";
            scanBox.insertBefore(span, slipInput);
          }
          Array.from(scanBox.children).forEach(child => {
            if (child.id !== "plusSign" && child.tagName !== "INPUT") {
              child.remove();
            }
          });
        }
        
      });


    });
    document.getElementById('slipInput').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      const previewImage = document.getElementById('previewImage');
      const pdfPreview = document.getElementById('pdfPreview');
      const plusSign = document.getElementById('plusSign');

      // Reset previews
      previewImage.style.display = 'none';
      pdfPreview.style.display = 'none';
      plusSign.style.display = 'block';

      if (!file) return;

      const reader = new FileReader();

      reader.onload = function (e) {
        if (file.type.startsWith('image/')) {
          previewImage.src = e.target.result;
          previewImage.style.display = 'block';
          plusSign.style.display = 'none';
        } else if (file.type === 'application/pdf') {
          pdfPreview.style.display = 'block';
          pdfPreview.querySelector('.pdf-name').textContent = file.name;
          plusSign.style.display = 'none';
        }
      };

      if (file) {
        if (file.type.startsWith('image/')) {
          reader.readAsDataURL(file);
        } else if (file.type === 'application/pdf') {
          reader.readAsDataURL(file);
          // For PDF we just show the PDF icon and name
          pdfPreview.style.display = 'block';
          pdfPreview.querySelector('.pdf-name').textContent = file.name;
          plusSign.style.display = 'none';
        }
      }
      if (!file) return;

      const resultDiv = document.getElementById('ocrResult');
      resultDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="bi bi-hourglass-split"></i> 
            Processing ${file.name}...
        </div>
    `;

      try {
        const formData = new FormData();
        formData.append('slip_image', file);

        const response = await fetch('/process-ocr', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            "X-CSRFToken": csrf_token
          },
          body: formData
        });

        // Handle non-JSON responses
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(`Invalid response format: ${text.slice(0, 100)}...`);
        }

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || `Server error: ${response.statusText}`);
        }

        if (data.success) {
          resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i>
                    ${data.amount ? `Detected amount: à¸¿${data.amount}` : 'Processing completed'}
                </div>
            `;
          console.log(data)
          if (data.amount) {
            document.getElementById('total').value = data.amount;
          }
        } else {
          throw new Error(data.error || 'Processing failed');
        }
      } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i>
                ${error.message.replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </div>
        `;
        console.error('OCR Error:', error);
      }
    });

    // In your OCR success handler:
    if (data.amount) {
        const totalInput = document.getElementById('total');
        totalInput.value = data.amount;
        formatNumber(totalInput); 
      }

      // keep only this version:
      function formatNumber(input) {
        let value = input.value.replace(/,/g, '');
        if (!isNaN(value) && value !== '') {
          let parts = value.split('.');
          parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
          input.value = parts.length > 1 ? parts.join('.') : parts[0];
        }
      }
  </script>
</body>

</html>