<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/budget.css') }}">
  <!-- Google font-->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li>
        <a href="{{ url_for('users_profile') }}" title="Profile">
          <span class="icon" id="sidebarProfileIcon">
            <img src="{{ current_user.avatar_url}}" alt="Profile" style="width:40px; height:40px; border-radius:50%;">
          </span>
          <span class="text">Profile</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('homepage') }}" title="Home">
          <span class="icon"><i class="bi bi-house-fill"></i></span>
          <span class="text">Home</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('all_transactions') }}" title="All_transaction">
          <span class="icon"><i class="bi bi-clipboard2-fill"></i></span>
          <span class="text">Transaction</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('budgets') }}" title="Budgets">
          <span class="icon"><i class="bi bi-credit-card-fill"></i></span>
          <span class="text">Budgets</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('report') }}" title="Charts">
          <span class="icon"><i class="bi bi-bar-chart-line-fill"></i></span>
          <span class="text">Charts</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('Calendar') }}" title="Calendar">
          <span class="icon"><i class="bi bi-calendar-event-fill"></i></span>
          <span class="text">Calendar</span>
        </a>
      </li>
      <div class="bottom">
        <li>
          <a href="{{ url_for('categories_management') }}" title="Categories Management">
            <span class="icon"><i class="bi bi-sliders"></i></span>
            <span class="text">Categories<br>Management</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('users_logout') }}" title="Logout">
            <span class="icon"><i class="bi bi-box-arrow-left"></i></span>
            <span class="text">Logout</span>
          </a>
        </li>
      </div>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h1 class="mb-4">Charts</h1>
    <!-- ฟอร์มสำหรับกรองข้อมูล (ถ้าต้องการ) -->
    <div class="col-md-6 d-flex">
      <form method="get" action="{{ url_for('report') }}" class="d-flex align-items-center" id="dateFilterForm">
          <select name="filter" id="filter" class="form-select me-2" style="width: auto;">
              <option value="day" {% if request.args.get('filter', 'day' )=='day' %}selected{% endif %}>Day</option>
              <option value="week" {% if request.args.get('filter', 'day' )=='week' %}selected{% endif %}>Week</option>
              <option value="month" {% if request.args.get('filter', 'day' )=='month' %}selected{% endif %}>Month</option>
              <option value="year" {% if request.args.get('filter', 'day' )=='year' %}selected{% endif %}>Year</option>
          </select>
          <button type="button" class="btn btn-light me-2" id="prevDate">
              <i class="bi bi-chevron-left"></i>
          </button>
          <input type="date" name="date" id="date" class="form-control me-2" style="width: auto;"
              value="{{ request.args.get('date', current_date) }}">
          <button type="button" class="btn btn-light me-2" id="nextDate">
              <i class="bi bi-chevron-right"></i>
          </button>
      </form>
  </div>
  <div class="row">
      <div class="col">
          <small id="dateRangeDisplay" class="text-muted"></small>
      </div>
  </div>
  
    <br>
    <div class="row mb-3">
      <div class="col-12 filter-form">
        <!-- ตัวเลือก Transaction Type -->
        <label for="chartType">Show all categories of :</label>
        <label>
            <input type="radio" name="transactionType" value="expense" checked> Expense
          </label>
          <label>
            <input type="radio" name="transactionType" value="income"> Income
          </label>
          <label>
            <input type="radio" name="transactionType" value="Both"> Both
          </label>          
      </div>
    </div>

    <!-- ส่วนที่เปลี่ยนแปลงใน HTML สำหรับเลือก Chart Type -->
    <div class="row mb-3">
      <div class="col-12 filter-form">
        <div class="row">
          <div class="col-auto">
            <label>Chart Type :</label><br>
          </div>
          <div class="col-auto">
            <label>
              <input type="radio" name="chartType" value="pie" checked> Pie chart
            </label>
            <br>
            <label>
              <input type="radio" name="chartType" value="bar"> Bar chart
            </label>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12 filter-form">
        <!-- ปุ่มแสดงรายงาน -->
        <button id="showReportBtn" class="btn btn-primary">SHOW REPORT</button>
      </div>
    </div>

    <!-- ส่วนที่จะแสดงกราฟ -->
    <div class="row-auto">
      <div class="col-auto chart-container">
        <canvas id="myChart"></canvas>
        <div id="chartMessage"></div>
      </div>
    </div>
  </div>


  <!-- ส่งข้อมูลรายการธุรกรรมจากฐานข้อมูลไปยัง JavaScript -->
  <script>
    const transactions = {{ transactions | tojson | safe }};
    console.log(transactions);
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function formatLocalDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function updateRangeDisplay() {
        const filterType = document.getElementById("filter").value;
        const dateInput = document.getElementById("date");
        const displayEl = document.getElementById("dateRangeDisplay");
        let currentDate = new Date(dateInput.value);
        let startDate, endDate;

        if (filterType === "day") {
            startDate = new Date(currentDate);
            endDate = new Date(currentDate);
        } else if (filterType === "week") {
            const day = currentDate.getDay();
            const diff = currentDate.getDate() - day + (day === 0 ? -6 : 1);
            startDate = new Date(currentDate);
            startDate.setDate(diff);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
        } else if (filterType === "month") {
            startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        } else if (filterType === "year") {
            startDate = new Date(currentDate.getFullYear(), 0, 1);
            endDate = new Date(currentDate.getFullYear(), 11, 31);
        }

        displayEl.textContent = `Showing transactions from ${formatLocalDate(startDate)} to ${formatLocalDate(endDate)}`;
    }

    function adjustDate(increment) {
        const filterType = document.getElementById("filter").value;
        const dateInput = document.getElementById("date");
        let currentDate = new Date(dateInput.value);

        if (filterType === "day") {
            currentDate.setDate(currentDate.getDate() + increment);
        } else if (filterType === "week") {
            currentDate.setDate(currentDate.getDate() + (7 * increment));
        } else if (filterType === "month") {
            currentDate.setMonth(currentDate.getMonth() + increment);
        } else if (filterType === "year") {
            currentDate.setFullYear(currentDate.getFullYear() + increment);
        }

        dateInput.value = formatLocalDate(currentDate);
        updateRangeDisplay();
    }

    // ผูก Event Listeners
    document.getElementById("prevDate").addEventListener("click", () => adjustDate(-1));
    document.getElementById("nextDate").addEventListener("click", () => adjustDate(1));
    document.getElementById("date").addEventListener("change", updateRangeDisplay);
    document.getElementById("filter").addEventListener("change", updateRangeDisplay);
    
    // อัพเดทแสดงผลครั้งแรก
    updateRangeDisplay();
});

</script>

  <!-- JavaScript สำหรับ Chart.js -->
  <script>
    let myChart;

    function generateTransactionTable(filtered, totalAmount, transactionType) {
    if (filtered.length === 0) {
        document.getElementById('transactionSummary').innerHTML = "<p>No transactions found.</p>";
        return;
    }

    const categoryTotals = {};
    filtered.forEach(t => {
      const category = t.category?.name || 'Other';
        if (!categoryTotals[category]) {
            categoryTotals[category] = 0;
        }
        categoryTotals[category] += parseFloat(t.transaction.amount);
    });

    let tableHtml = `<div class="table-container"><table class="table table-bordered">
        <thead><tr><th>Category</th><th>Amount</th><th>Percentage</th></tr></thead><tbody>`;

    Object.keys(categoryTotals).forEach(category => {
        const amount = categoryTotals[category];
        const percentage = ((amount / totalAmount) * 100).toFixed(2);
        tableHtml += `<tr>
            <td>${category}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${percentage}%</td>
        </tr>`;
    });

    tableHtml += `</tbody></table></div>`;
    
    // แสดง Total
    tableHtml += `<p class="total-summary">Total: <span style="color: ${totalAmount < 0 ? 'red' : 'green'};">
        ${totalAmount.toFixed(2)}
    </span></p>`;

    document.getElementById('transactionSummary').innerHTML = tableHtml;
}

function showReport() {
    const { filtered, chartType, transactionType } = filterTransactions(transactions);
    const totalAmount = filtered.reduce((sum, t) => sum + parseFloat(t.transaction.amount), 0);
    generateTransactionTable(filtered, totalAmount, transactionType);
    
    const grouped = groupByCategory(filtered);
    const labels = Object.keys(grouped);
    const data = Object.values(grouped);
    renderChart(chartType, labels, data);
}



document.getElementById('showReportBtn').addEventListener('click', showReport);

  // ฟังก์ชันคำนวณช่วงวันที่ตาม filter
function getDateRange() {
  const filterType = document.getElementById("filter").value;
  const dateInput = document.getElementById("date").value;
  let currentDate = new Date(dateInput);
  let startDate, endDate;
  
  if (filterType === "day") {
    startDate = new Date(currentDate);
    endDate = new Date(currentDate);
  } else if (filterType === "week") {
    const day = currentDate.getDay();
    const diff = currentDate.getDate() - day + (day === 0 ? -6 : 1);
    startDate = new Date(currentDate);
    startDate.setDate(diff);
    endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
  } else if (filterType === "month") {
    startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  } else if (filterType === "year") {
    startDate = new Date(currentDate.getFullYear(), 0, 1);
    endDate = new Date(currentDate.getFullYear(), 11, 31);
  }
  
  // แปลงวันที่ให้เป็น string ในรูปแบบ YYYY-MM-DD
  function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }
  
  return { start: formatDate(startDate), end: formatDate(endDate) };
}  

  // ปรับปรุงฟังก์ชัน filterTransactions ให้ใช้ช่วงวันที่ตาม filter
  function filterTransactions(data) {
  const transactionTypeEls = document.getElementsByName('transactionType');
  const chartType = document.querySelector('input[name="chartType"]:checked').value;
  let selectedTransactionType = 'Both';

  transactionTypeEls.forEach(el => {
    if (el.checked) selectedTransactionType = el.value;
  });

    const filterType = document.getElementById("filter").value;
    const selectedDate = document.getElementById('date').value;
    let filtered = data;

    // กรองตามประเภท (ถ้าไม่ใช่ Both)
    if (selectedTransactionType !== 'Both') {
      filtered = filtered.filter(t => t.transaction_type.toLowerCase() === selectedTransactionType.toLowerCase());
    }

    // กรองตามวันที่: ถ้า filter เป็น "day" ให้เปรียบเทียบเท่ากับ แต่ถ้าเป็น week, month, year ให้ใช้ช่วงวันที่
    if (filterType === 'day') {
      filtered = filtered.filter(t => t.transaction_date === selectedDate);
    } else {
      const { start, end } = getDateRange();
      filtered = filtered.filter(t => t.transaction_date >= start && t.transaction_date <= end);
    }

    return { filtered, chartType, transactionType: selectedTransactionType };
  }

  // จัดกลุ่มข้อมูลตาม category (ใช้เมื่อเลือก income หรือ expense)
  function groupByCategory(transactions) {
    const map = {};
    transactions.forEach(t => {
      const catName = t.category?.name || 'Other';
      if (!map[catName]) map[catName] = 0;
      map[catName] += parseFloat(t.amount);
    });
    return map;
  }

  // ฟังก์ชันสำหรับสร้างหรืออัปเดต Chart
  function renderChart(chartType, labels, data) {
    if (myChart) myChart.destroy();
    const ctx = document.getElementById('myChart').getContext('2d');
    myChart = new Chart(ctx, {
      type: chartType,
      data: {
        labels: labels,
        datasets: [{
          label: 'Amount',
          data: data,
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56',
            '#4BC0C0', '#9966FF', '#FF9F40'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          title: {
            display: true,
            text: `${chartType.toUpperCase()} Chart - ${document.querySelector('input[name="transactionType"]:checked').value.toUpperCase()}`
          }
        }
      }
    });
  }

  // ฟังก์ชันหลักเมื่อกดปุ่ม "SHOW REPORT"
  function showReport() {
    const { filtered, chartType, transactionType } = filterTransactions(transactions);
    const chartMessageEl = document.getElementById('chartMessage');

    if (transactionType === "Both") {
      // กรณีเลือก Both: สรุปยอด income และ expense แยกกัน
      let incomeTotal = 0, expenseTotal = 0;
      filtered.forEach(t => {
        if (t.transaction_type.toLowerCase() === 'income') {
          incomeTotal += parseFloat(t.amount);
        } else if (t.transaction_type.toLowerCase() === 'expense') {
          expenseTotal += parseFloat(t.amount);
        }
      });
      if (incomeTotal === 0 && expenseTotal === 0) {
        if (myChart) myChart.destroy();
        document.getElementById('myChart').style.display = "none";
        chartMessageEl.innerHTML = '<p class="center">there is no income or expenses.</p>';
      } else {
        document.getElementById('myChart').style.display = "block";
        chartMessageEl.innerHTML = "";
        renderChart(chartType, ['Income', 'Expense'], [incomeTotal, expenseTotal]);
      }
    } else {
      // กรณีเลือกเฉพาะ income หรือ expense
      let totalAmount = filtered.reduce((sum, t) => sum + parseFloat(t.amount), 0);
      if (totalAmount === 0) {
        if (myChart) myChart.destroy();
        document.getElementById('myChart').style.display = "none";
        chartMessageEl.innerHTML = `<p class="center">No ${transactionType}.</p>`;
      } else {
        document.getElementById('myChart').style.display = "block";
        chartMessageEl.innerHTML = "";
        const grouped = groupByCategory(filtered);
        const labels = Object.keys(grouped);
        const data = Object.values(grouped);
        renderChart(chartType, labels, data);
      }
    }
  }

  // ผูก event ให้ปุ่ม SHOW REPORT
  document.getElementById('showReportBtn').addEventListener('click', showReport);
  </script>

  <!-- Bootstrap and Plugin JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
</body>
</html>
