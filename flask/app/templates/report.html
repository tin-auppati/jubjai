<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Report</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/report.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/new_expense.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <ul>
      <li>
        <a href="{{ url_for('users_profile') }}" title="Profile">
          <span class="icon"><i class="bi bi-person-circle"></i></span>
          <span class="text">Profile</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('homepage') }}" title="Home">
          <span class="icon"><i class="bi bi-house-fill"></i></span>
          <span class="text">Home</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('all_transactions') }}" title="All_transaction">
          <span class="icon"><i class="bi bi-clipboard2-fill"></i></span>
          <span class="text">Transaction</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('create_transactions', transaction_type='income') }}" title="Income">
          <span class="icon"><i class="bi bi-graph-up"></i></span>
          <span class="text">Income</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('create_transactions', transaction_type='expense') }}" title="Expense">
          <span class="icon"><i class="bi bi-graph-down"></i></span>
          <span class="text">Expense</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('Budgets') }}" title="Budgets">
          <span class="icon"><i class="bi bi-bar-chart-fill"></i></span>
          <span class="text">Budgets</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('report') }}" title="Charts">
          <span class="icon"><i class="bi bi-bar-chart-fill"></i></span>
          <span class="text">Charts</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('Calendar') }}" title="Calendar">
          <span class="icon"><i class="bi bi-bar-chart-fill"></i></span>
          <span class="text">Calendar</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('Categories_management') }}" title="Categories_management">
          <span class="icon"><i class="bi bi-bar-chart-fill"></i></span>
          <span class="text">Categories_management</span>
        </a>
      </li>
      <div class="bottom">
        <li>
          <a href="{{ url_for('users_logout') }}" title="Logout">
            <span class="icon"><i class="bi bi-box-arrow-left"></i></span>
            <span class="text">Logout</span>
          </a>
        </li>
      </div>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- ฟอร์มสำหรับกรองข้อมูล (ถ้าต้องการ) -->
    <div class="col-md-6 d-flex">
      <form method="get" action="{{ url_for('report') }}" class="d-flex align-items-center" id="dateFilterForm">
          <select name="filter" id="filter" class="form-select me-2" style="width: auto;">
              <option value="day" {% if request.args.get('filter', 'day' )=='day' %}selected{% endif %}>Day</option>
              <option value="week" {% if request.args.get('filter', 'day' )=='week' %}selected{% endif %}>Week</option>
              <option value="month" {% if request.args.get('filter', 'day' )=='month' %}selected{% endif %}>Month</option>
              <option value="year" {% if request.args.get('filter', 'day' )=='year' %}selected{% endif %}>Year</option>
          </select>
          <button type="button" class="btn btn-light me-2" id="prevDate">
              <i class="bi bi-chevron-left"></i>
          </button>
          <input type="date" name="date" id="date" class="form-control me-2" style="width: auto;"
              value="{{ request.args.get('date', current_date) }}">
          <button type="button" class="btn btn-light me-2" id="nextDate">
              <i class="bi bi-chevron-right"></i>
          </button>
      </form>
  </div>
  <div class="row">
      <div class="col">
          <small id="dateRangeDisplay" class="text-muted"></small>
      </div>
  </div>
  

    <div class="row mb-3">
      <div class="col-12 filter-form">
        <!-- ตัวเลือก Transaction Type -->
        <label>
            <input type="radio" name="transactionType" value="expense" checked> Expense
          </label>
          <label>
            <input type="radio" name="transactionType" value="income"> Income
          </label>
          <label>
            <input type="radio" name="transactionType" value="Both"> Both
          </label>          
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12 filter-form">
        <!-- เลือกประเภทของ Chart -->
        <label for="chartType">Chart Type:</label>
        <select id="chartType">
          <option value="pie">Pie chart</option>
          <option value="bar">Bar chart</option>
        </select>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-12 filter-form">
        <!-- ปุ่มแสดงรายงาน -->
        <button id="showReportBtn" class="btn btn-primary">SHOW REPORT</button>
      </div>
    </div>

    <!-- ส่วนที่จะแสดงกราฟ -->
    <div class="row">
      <div class="col-12 chart-container">
        <canvas id="myChart"></canvas>
      </div>
    </div>
  </div>

  <!-- ส่งข้อมูลรายการธุรกรรมจากฐานข้อมูลไปยัง JavaScript -->
  <script>
    const transactions = {{ transactions | tojson | safe }};
    console.log(transactions);
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function formatLocalDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function updateRangeDisplay() {
        const filterType = document.getElementById("filter").value;
        const dateInput = document.getElementById("date");
        const displayEl = document.getElementById("dateRangeDisplay");
        let currentDate = new Date(dateInput.value);
        let startDate, endDate;

        if (filterType === "day") {
            startDate = new Date(currentDate);
            endDate = new Date(currentDate);
        } else if (filterType === "week") {
            const day = currentDate.getDay();
            const diff = currentDate.getDate() - day + (day === 0 ? -6 : 1);
            startDate = new Date(currentDate);
            startDate.setDate(diff);
            endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
        } else if (filterType === "month") {
            startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            endDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        } else if (filterType === "year") {
            startDate = new Date(currentDate.getFullYear(), 0, 1);
            endDate = new Date(currentDate.getFullYear(), 11, 31);
        }

        displayEl.textContent = `Showing transactions from ${formatLocalDate(startDate)} to ${formatLocalDate(endDate)}`;
    }

    function adjustDate(increment) {
        const filterType = document.getElementById("filter").value;
        const dateInput = document.getElementById("date");
        let currentDate = new Date(dateInput.value);

        if (filterType === "day") {
            currentDate.setDate(currentDate.getDate() + increment);
        } else if (filterType === "week") {
            currentDate.setDate(currentDate.getDate() + (7 * increment));
        } else if (filterType === "month") {
            currentDate.setMonth(currentDate.getMonth() + increment);
        } else if (filterType === "year") {
            currentDate.setFullYear(currentDate.getFullYear() + increment);
        }

        dateInput.value = formatLocalDate(currentDate);
        updateRangeDisplay();
    }

    // ผูก Event Listeners
    document.getElementById("prevDate").addEventListener("click", () => adjustDate(-1));
    document.getElementById("nextDate").addEventListener("click", () => adjustDate(1));
    document.getElementById("date").addEventListener("change", updateRangeDisplay);
    document.getElementById("filter").addEventListener("change", updateRangeDisplay);
    
    // อัพเดทแสดงผลครั้งแรก
    updateRangeDisplay();
});
</script>

  <!-- JavaScript สำหรับ Chart.js -->
  <script>
    let myChart;

    function generateTransactionTable(filtered, totalAmount, transactionType) {
    if (filtered.length === 0) {
        document.getElementById('transactionSummary').innerHTML = "<p>No transactions found.</p>";
        return;
    }

    const categoryTotals = {};
    filtered.forEach(t => {
      const category = t.category?.name || 'Other';
        if (!categoryTotals[category]) {
            categoryTotals[category] = 0;
        }
        categoryTotals[category] += parseFloat(t.transaction.amount);
    });

    let tableHtml = `<div class="table-container"><table class="table table-bordered">
        <thead><tr><th>Category</th><th>Amount</th><th>Percentage</th></tr></thead><tbody>`;

    Object.keys(categoryTotals).forEach(category => {
        const amount = categoryTotals[category];
        const percentage = ((amount / totalAmount) * 100).toFixed(2);
        tableHtml += `<tr>
            <td>${category}</td>
            <td>${amount.toFixed(2)}</td>
            <td>${percentage}%</td>
        </tr>`;
    });

    tableHtml += `</tbody></table></div>`;
    
    // แสดง Total
    tableHtml += `<p class="total-summary">Total: <span style="color: ${totalAmount < 0 ? 'red' : 'green'};">
        ${totalAmount.toFixed(2)}
    </span></p>`;

    document.getElementById('transactionSummary').innerHTML = tableHtml;
}

function showReport() {
    const { filtered, chartType, transactionType } = filterTransactions(transactions);
    const totalAmount = filtered.reduce((sum, t) => sum + parseFloat(t.transaction.amount), 0);
    generateTransactionTable(filtered, totalAmount, transactionType);
    
    const grouped = groupByCategory(filtered);
    const labels = Object.keys(grouped);
    const data = Object.values(grouped);
    renderChart(chartType, labels, data);
}



document.getElementById('showReportBtn').addEventListener('click', showReport);

  
    // ฟังก์ชันสำหรับกรองข้อมูล โดยอ้างอิงข้อมูลใน key "transaction"
    function filterTransactions(data) {
    const transactionTypeEls = document.getElementsByName('transactionType');
    const chartType = document.getElementById('chartType').value;
    let selectedTransactionType = 'Both';

    transactionTypeEls.forEach(el => {
        if (el.checked) selectedTransactionType = el.value;
    });

    const selectedDate = document.getElementById('date').value;
    let filtered = data;

    if (selectedTransactionType !== 'Both') {
      filtered = filtered.filter(t => t.transaction_type.toLowerCase() === selectedTransactionType.toLowerCase());
    }

    if (selectedDate) {
        filtered = filtered.filter(t => t.transaction_date === selectedDate);
    }

    return { filtered, chartType, transactionType: selectedTransactionType };
}

function groupByCategory(transactions) {
  const map = {};
  transactions.forEach((t) => {
    // ใช้ข้อมูล category จาก field ที่ map มา
    const catName = t.category?.name || 'Other'; 
    if (!map[catName]) map[catName] = 0;
    map[catName] += parseFloat(t.amount);
  });
  return map;
}
  
    // ฟังก์ชันสำหรับสร้างหรืออัปเดต Chart
    function renderChart(chartType, labels, data) {
  if (myChart) myChart.destroy();
  
  const ctx = document.getElementById('myChart').getContext('2d');
  myChart = new Chart(ctx, {
    type: chartType,
    data: {
      labels: labels,
      datasets: [{
        label: 'Amount',
        data: data,
        backgroundColor: [
          '#FF6384', '#36A2EB', '#FFCE56', 
          '#4BC0C0', '#9966FF', '#FF9F40'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        title: { 
          display: true, 
          text: `${document.getElementById('chartType').value.toUpperCase()} Chart - ${document.querySelector('input[name="transactionType"]:checked').value.toUpperCase()}`
        }
      }
    }
  });
}

// ปรับขนาด canvas ด้วย CSS
document.getElementById('myChart').parentElement.style.height = '600px';
document.getElementById('myChart').parentElement.style.width = '800px';

  
    // ฟังก์ชันหลัก เมื่อกดปุ่ม "SHOW REPORT"
    function showReport() {
      const { filtered, chartType } = filterTransactions(transactions);
      const grouped = groupByCategory(filtered);
      const labels = Object.keys(grouped);
      const data = Object.values(grouped);
      renderChart(chartType, labels, data);
    }
  
    // ผูก event ให้ปุ่ม SHOW REPORT
    document.getElementById('showReportBtn').addEventListener('click', showReport);
  </script>

  <!-- Bootstrap and Plugin JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
</body>
</html>
