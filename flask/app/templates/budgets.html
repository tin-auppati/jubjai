<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>My Budgets</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- Bootstrap Select CSS -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/budget.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
</head>

<body>
  <!-- Sidebar-->
  <div class="sidebar">
    <ul>
      <li>
        <a href="{{ url_for('users_profile') }}" title="Profile">
          <span class="icon" id="sidebarProfileIcon">
            <img src="{{ current_user.avatar_url}}" alt="Profile" style="width:40px; height:40px; border-radius:50%;">
          </span>
          <span class="text">Profile</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('homepage') }}" title="Home">
          <span class="icon"><i class="bi bi-house-fill"></i></span>
          <span class="text">Home</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('all_transactions') }}" title="All_transaction">
          <span class="icon"><i class="bi bi-clipboard2-fill"></i></span>
          <span class="text">Transaction</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('budgets') }}" title="Budgets">
          <span class="icon"><i class="bi bi-credit-card-fill"></i></span>
          <span class="text">Budgets</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('report') }}" title="Charts">
          <span class="icon"><i class="bi bi-bar-chart-line-fill"></i></span>
          <span class="text">Charts</span>
        </a>
      </li>
      <li>
        <a href="{{ url_for('Calendar') }}" title="Calendar">
          <span class="icon"><i class="bi bi-calendar-event-fill"></i></span>
          <span class="text">Calendar</span>
        </a>
      </li>
      <div class="bottom">
        <li>
          <a href="{{ url_for('categories_management') }}" title="Categories Management">
            <span class="icon"><i class="bi bi-sliders"></i></span>
            <span class="text">Categories<br>Management</span>
          </a>
        </li>
        <li>
          <a href="{{ url_for('users_logout') }}" title="Logout">
            <span class="icon"><i class="bi bi-box-arrow-left"></i></span>
            <span class="text">Logout</span>
          </a>
        </li>
      </div>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <h2>My Budgets</h2>

    {% for group, budgets in grouped_budgets.items() %}
    {% if budgets %}
    <h3 style="text-align: center; font-weight: 600;">{{ group }} Budgets</h3>
    <div class="budget-container">
      {% for budget in budgets %}
      <div class="budget-card" style="position: relative; margin-bottom: 1rem;">
        <div class="row">
          <div class="col">
            <span class="category-name">{{ budget.name }}</span>
          </div>
        </div>
        <div class="d-flex align-items-center">
          <img class="category-icon" src="{{ budget.icon_url }}" alt="{{ budget.name }} Icon"
            style="width:40px; height:40px;">
          <div class="bar flex-grow-1 ms-3">
            <div class="row">
              <div class="col text-start">
                <span class="start-date">{{ budget.start_date.strftime('%Y-%m-%d') }}</span>
              </div>
              <div class="col text-center">
                <span class="amount">{{ "%.2f"|format(budget.percent_used) }} %</span>
              </div>
              <div class="col text-end">
                <span class="end-date">{{ budget.end_date.strftime('%Y-%m-%d') }}</span>
              </div>
            </div>
            <div class="row my-1">
              <div class="progress-bar w-100">
                <div class="progress-fill"
                  style="width: {{ budget.percent_used }}%; background-color: {% if budget.percent_used >= 100 %} red {% endif %};">
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col text-start">
                <span class="amount">0.00</span>
              </div>
              <div class="col text-center">
                <span class="amount">{{ budget.spent_amount }}</span>
              </div>
              <div class="col text-end">
                <span class="budget">{{ budget.limit }}</span>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-2">
          <div class="col text-start">
            <span class="remain">Residual amount: {{ budget.remaining }}</span>
          </div>
          <div class="col text-end">
            <!-- Edit Budget Button -->
            <button class="btn edit-budget" data-bs-toggle="modal" data-bs-target="#editBudgetModal{{ budget.category_id }}"
              data-budgetid="{{ budget.category_id }}" data-monthlylimit="{{ budget.limit }}">
              <i class="bi bi-pencil-square"></i>
            </button>
            <!-- Edit Budget Modal -->
            <div class="modal fade" id="editBudgetModal{{ budget.category_id }}" tabindex="-1"
              aria-labelledby="editBudgetModalLabel{{ budget.category_id }}" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form id="editBudgetForm{{ budget.category_id }}" method="POST" action="{{ url_for('edit_category_budget') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="category_id" value="{{ budget.category_id }}">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editBudgetModalLabel{{ budget.category_id }}">Edit Budget</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <!-- Category Name-->
                      <div class="mb-3">
                        <label for="editCategoryName{{ budget.category_id }}" class="form-label">Category</label>
                        <input type="text" class="form-control" id="editCategoryName{{ budget.category_id }}"
                          value="{{ budget.name }}" disabled>
                      </div>
                      <!-- Monthly Limit -->
                      <div class="mb-3">
                        <label for="editMonthlyLimit{{ budget.category_id }}" class="form-label">Monthly Limit</label>
                        <input type="number" step="0.01" class="form-control" id="editMonthlyLimit{{ budget.category_id }}"
                          name="new_budget" value="{{ budget.limit }}" required>
                      </div>
                      <!-- Duration Selection -->
                      <div class="mb-3">
                        <label for="editDurationSelect{{ budget.category_id }}" class="form-label">Duration</label>
                        <select class="form-select" id="editDurationSelect{{ budget.category_id }}" name="duration_type" required>
                          <option value="week" {% if (budget.end_date - budget.start_date).days + 1==7 %}selected{% endif %}>1 Week
                          </option>
                          <option value="month" {% if (budget.end_date - budget.start_date).days + 1>= 28 and (budget.end_date -
                            budget.start_date).days + 1 <= 31 %}selected{% endif %}>1 Month</option>
                          <option value="year" {% if (budget.end_date - budget.start_date).days + 1>= 360 and (budget.end_date -
                            budget.start_date).days + 1 <= 370 %}selected{% endif %}>1 Year</option>
                          <option value="custom" {% if not ((budget.end_date - budget.start_date).days + 1==7 or ((budget.end_date -
                            budget.start_date).days + 1>= 28 and (budget.end_date - budget.start_date).days + 1 <= 31) or
                              ((budget.end_date - budget.start_date).days + 1>= 360 and (budget.end_date - budget.start_date).days +
                              1 <= 370)) %}selected{% endif %}>Custom</option>
                        </select>
                      </div>
                      <div id="editCustomDurationInputs{{ budget.category_id }}"
                        style="display: {% if (budget.end_date - budget.start_date).days + 1 not in [7] and ((budget.end_date - budget.start_date).days + 1 < 28 or (budget.end_date - budget.start_date).days + 1 > 31) and ((budget.end_date - budget.start_date).days + 1 < 360 or (budget.end_date - budget.start_date).days + 1 > 370) %}block{% else %}none{% endif %};">
                        <div class="mb-3">
                          <label for="editCustomStartDate{{ budget.category_id }}" class="form-label">Start Date</label>
                          <input type="date" class="form-control" id="editCustomStartDate{{ budget.category_id }}"
                            name="custom_start_date" value="{{ budget.start_date.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="mb-3">
                          <label for="editCustomEndDate{{ budget.category_id }}" class="form-label">End Date</label>
                          <input type="date" class="form-control" id="editCustomEndDate{{ budget.category_id }}"
                            name="custom_end_date" value="{{ budget.end_date.strftime('%Y-%m-%d') }}">
                        </div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <!-- Delete Budget Form -->
            <form method="POST" action="{{ url_for('delete_category_budget', category_id=budget.category_id) }}"
              class="d-inline-block">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" onclick="return confirm('คุณแน่ใจว่าต้องการลบข้อมูลนี้?');" class="btn">
                <i class="bi bi-trash3"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}

    </div>
    {% endif %}
    {% endfor %}
  </div>
  <button class="floating-btn" id="openModalBtn">+</button>
  <!-- Insert Budget Opinion Modal Overlay -->
  <div class="modal-overlay" id="budgetModal">
    <div class="modal-content-custom">
      <h4>Insert Budget Opinion</h4>
      <form action="{{ url_for('update_category_budget') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <div class="mb-3">
          <label for="categorySelect" class="form-label">Select Expense Category</label>
          <select class="selectpicker" id="categorySelect" name="category_id" required data-live-search="true">
            {% for cat in categories_expense %}
            <option value="{{ cat.category_id }}"
              data-content="<img src='{{ cat.icon_url }}' height='25' style='margin-right:8px;'/> {{ cat.name }}">
              {{ cat.name }}
            </option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="budgetInput" class="form-label">Budget Amount</label>
          <input type="number" step="0.01" class="form-control" id="budgetInput" name="new_budget"
            placeholder="Enter new budget" required>
        </div>

        <!-- Duration Selection -->
        <div class="mb-3">
          <label for="durationSelect" class="form-label">Duration</label>
          <select class="form-select" id="durationSelect" name="duration_type" required>
            <option value="week">1 Week</option>
            <option value="month" selected>1 Month</option>
            <option value="year">1 Year</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <!-- Custom Duration Date Inputs -->
        <div id="customDurationInputs" style="display: none;">
          <div class="mb-3">
            <label for="customStartDate" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="customStartDate" name="custom_start_date">
          </div>
          <div class="mb-3">
            <label for="customEndDate" class="form-label">End Date</label>
            <input type="date" class="form-control" id="customEndDate" name="custom_end_date">
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Submit</button>
        <button type="button" class="btn btn-secondary" id="closeModalBtn">Cancel</button>
      </form>
    </div>
  </div>

  <!-- Edit Budget Modal Overlay -->
  <div class="modal-overlay" id="editBudgetModal" style="display: none;">
    <div class="modal-content-custom">
      <h4>Edit Budget</h4>
      <form action="{{ url_for('edit_category_budget') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="category_id" id="editCategoryId">

        <div class="mb-3">
          <label for="editCategoryName" class="form-label">Category</label>
          <input type="text" class="form-control" id="editCategoryName" disabled>
        </div>

        <div class="mb-3">
          <label for="editBudgetInput" class="form-label">Budget Amount</label>
          <input type="number" step="0.01" class="form-control" id="editBudgetInput" name="new_budget" required>
        </div>

        <!-- Duration Selection -->
        <div class="mb-3">
          <label for="editDurationSelect" class="form-label">Duration</label>
          <select class="form-select" id="editDurationSelect" name="duration_type" required>
            <option value="week">1 Week</option>
            <option value="month" selected>1 Month</option>
            <option value="year">1 Year</option>
            <option value="custom">Custom</option>
          </select>
        </div>

        <!-- Custom Duration Date Inputs for Edit -->
        <div id="editCustomDurationInputs" style="display: none;">
          <div class="mb-3">
            <label for="editCustomStartDate" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="editCustomStartDate" name="custom_start_date">
          </div>
          <div class="mb-3">
            <label for="editCustomEndDate" class="form-label">End Date</label>
            <input type="date" class="form-control" id="editCustomEndDate" name="custom_end_date">
          </div>
        </div>

        <button type="submit" class="btn btn-primary">Update</button>
        <button type="button" class="btn btn-secondary" id="closeEditModalBtn">Cancel</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const durationSelect = document.getElementById("durationSelect");
      const customDurationInputs = document.getElementById("customDurationInputs");

      function toggleCustomDuration() {
        if (durationSelect.value === "custom") {
          customDurationInputs.style.display = "block";
        } else {
          customDurationInputs.style.display = "none";
        }
      }

      durationSelect.addEventListener("change", toggleCustomDuration);
      toggleCustomDuration();
    });

    document.addEventListener("DOMContentLoaded", function () {
      const editDurationSelect = document.getElementById("editDurationSelect");
      const editCustomDurationInputs = document.getElementById("editCustomDurationInputs");

      function toggleEditCustomDuration() {
        if (editDurationSelect.value === "custom") {
          editCustomDurationInputs.style.display = "block";
        } else {
          editCustomDurationInputs.style.display = "none";
        }
      }

      editDurationSelect.addEventListener("change", toggleEditCustomDuration);
      toggleEditCustomDuration();
    });

    document.addEventListener("DOMContentLoaded", function () {
      $('.selectpicker').selectpicker();

      const openModalBtn = document.getElementById('openModalBtn');
      const closeModalBtn = document.getElementById('closeModalBtn');
      const budgetModal = document.getElementById('budgetModal');

      openModalBtn.addEventListener('click', () => {
        budgetModal.style.display = 'flex';
      });

      closeModalBtn.addEventListener('click', () => {
        budgetModal.style.display = 'none';
      });

      window.addEventListener('click', (e) => {
        if (e.target === budgetModal) {
          budgetModal.style.display = 'none';
        }
      });
    });
    document.addEventListener("DOMContentLoaded", function () {
      $('.selectpicker').selectpicker();

      const editBudgetModal = document.getElementById('editBudgetModal');
      const closeEditModalBtn = document.getElementById('closeEditModalBtn');
      const editBudgetButtons = document.querySelectorAll('.edit-budget-btn');

      editBudgetButtons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          const categoryId = this.getAttribute('data-category-id');
          const currentBudget = this.getAttribute('data-current-budget');
          const categoryName = this.getAttribute('data-category-name');

          document.getElementById('editCategoryId').value = categoryId;
          document.getElementById('editCategoryName').value = categoryName;
          document.getElementById('editBudgetInput').value = currentBudget;

          editBudgetModal.style.display = 'flex';
        });
      });

      closeEditModalBtn.addEventListener('click', function () {
        editBudgetModal.style.display = 'none';
      });

      window.addEventListener('click', function (e) {
        if (e.target === editBudgetModal) {
          editBudgetModal.style.display = 'none';
        }
      });
    });
  </script>
</body>

</html>