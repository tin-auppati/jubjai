<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    {% if transaction_type == 'income' %}
    <title>All Incomes</title>
    {% elif transaction_type == 'expense' %}
    <title>All Expenses</title>
    {% else %}
    <title>All Transactions</title>
    {% endif %}
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all_expense.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <ul>
            <li>
                <a href="{{ url_for('users_profile') }}" title="Profile">
                    <span class="icon"><i class="bi bi-person-circle"></i></span>
                    <span class="text">Profile</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('homepage') }}" title="Home">
                    <span class="icon"><i class="bi bi-house-fill"></i></span>
                    <span class="text">Home</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('all_transactions') }}" title="All Transactions">
                    <span class="icon"><i class="bi bi-clipboard2-fill"></i></span>
                    <span class="text">Transaction</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('create_transactions', transaction_type='income') }}" title="Income">
                    <span class="icon"><i class="bi bi-graph-up"></i></span>
                    <span class="text">Income</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('create_transactions', transaction_type='expense') }}" title="Expense">
                    <span class="icon"><i class="bi bi-graph-down"></i></span>
                    <span class="text">Expense</span>
                </a>
            </li>
            <li>
                <a href="{{ url_for('report') }}" title="Report">
                    <span class="icon"><i class="bi bi-bar-chart-fill"></i></span>
                    <span class="text">Report</span>
                </a>
            </li>
            <div class="bottom">
                <li>
                    <a href="{{ url_for('users_logout') }}" title="Logout">
                        <span class="icon"><i class="bi bi-box-arrow-left"></i></span>
                        <span class="text">Logout</span>
                    </a>
                </li>
            </div>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content my-4">
        <h2 class="mb-4">
            {% if transaction_type == 'income' %}
            All Incomes
            {% elif transaction_type == 'expense' %}
            All Expenses
            {% else %}
            All Transactions
            {% endif %}
        </h2>

        <!-- Filter Buttons for Transaction Type -->
        <div class="row mb-3 align-items-center">
            <div class="col-md-6">
                <a href="{{ url_for('all_transactions', transaction_type='all', filter=request.args.get('filter', 'month'), date=request.args.get('date', current_date)) }}"
                    class="btn {% if transaction_type=='all' %}btn-primary{% else %}btn-outline-primary{% endif %} me-2">
                    All Transactions
                </a>
                <a href="{{ url_for('all_transactions', transaction_type='expense', filter=request.args.get('filter', 'month'), date=request.args.get('date', current_date)) }}"
                    class="btn {% if transaction_type=='expense' %}btn-primary{% else %}btn-outline-primary{% endif %} me-2">
                    Expenses
                </a>
                <a href="{{ url_for('all_transactions', transaction_type='income', filter=request.args.get('filter', 'month'), date=request.args.get('date', current_date)) }}"
                    class="btn {% if transaction_type=='income' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                    Incomes
                </a>
            </div>

            <!-- Right side: Date Filter with Arrows -->
            <div class="col-md-6 d-flex justify-content-end">
                <form method="get" action="{{ url_for('all_transactions') }}" class="d-flex align-items-center"
                    id="dateFilterForm">
                    <input type="hidden" name="transaction_type" value="{{ transaction_type }}">
                    <select name="filter" id="filter" class="form-select me-2" style="width: auto;">
                        <option value="day" {% if request.args.get('filter', 'month' )=='day' %}selected{% endif %}>Day
                        </option>
                        <option value="week" {% if request.args.get('filter', 'month' )=='week' %}selected{% endif %}>
                            Week</option>
                        <option value="month" {% if request.args.get('filter', 'month' )=='month' %}selected{% endif %}>
                            Month</option>
                        <option value="year" {% if request.args.get('filter', 'month' )=='year' %}selected{% endif %}>
                            Year</option>
                    </select>
                    <button type="button" class="btn btn-light me-2" id="prevDate">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <input type="date" name="date" id="date" class="form-control me-2" style="width: auto;"
                        value="{{ request.args.get('date', current_date) }}">
                    <button type="button" class="btn btn-light me-2" id="nextDate">
                        <i class="bi bi-chevron-right"></i>
                    </button>
                    <button type="submit" class="btn btn-secondary">Apply</button>
                </form>
            </div>
            <div class="row">
                <div class="col text-end">
                    <small id="dateRangeDisplay" class="text-muted"></small>
                </div>
            </div>
        </div>

        <!-- Transaction Table -->
        <table class="expense-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th style="width: 50px;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction, category in transactions %}
                <tr id="row-{{ transaction.transaction_id }}">
                    <td>
                        <div class="category-cell d-flex align-items-center">
                            <img src="{{ category.icon_url }}" alt="{{ category.name }} Icon"
                                style="width:30px; height:30px; margin-right:8px;">
                            <span>{{ category.name }}</span>
                        </div>
                    </td>
                    <td>
                        {% if transaction.transaction_type == 'income' %}
                        <span class="green-amount">+ ฿{{ "{:,.2f}".format(transaction.amount) }}</span>
                        {% else %}
                        <span class="red-amount">- ฿{{ "{:,.2f}".format(transaction.amount) }}</span>
                        {% endif %}
                    </td>
                    <td>{{ transaction.transaction_date.strftime('%m/%d/%Y') }}</td>
                    <td>{{ transaction.description }}</td>
                    <td class="text-end">
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="dropdown-item edit-transaction" href="#"
                                        data-id="{{ transaction.transaction_id }}"
                                        data-amount="{{ transaction.amount }}"
                                        data-date="{{ transaction.transaction_date.strftime('%Y-%m-%d') }}"
                                        data-description="{{ transaction.description }}">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item text-danger delete-transaction" href="#"
                                        data-id="{{ transaction.transaction_id }}"
                                        data-row-id="row-{{ transaction.transaction_id }}">
                                        <i class="bi bi-trash"></i> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Floating Action Buttons -->
    <div class="floating-buttons">
        <a href="{{ url_for('create_transactions', transaction_type='income') }}" class="btn btn-success floating-btn">
            <i class="bi bi-plus-circle"></i>
        </a>
        <a href="{{ url_for('create_transactions', transaction_type='expense') }}" class="btn btn-danger floating-btn">
            <i class="bi bi-dash-circle"></i>
        </a>
    </div>
    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="editTransactionForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTransactionModalLabel">Edit Transaction</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editTransactionId">
                        <div class="mb-3">
                            <label for="editAmount" class="form-label">Amount</label>
                            <input type="number" step="0.01" class="form-control" id="editAmount" required>
                        </div>
                        <div class="mb-3">
                            <label for="editTransactionDate" class="form-label">Transaction Date</label>
                            <input type="date" class="form-control" id="editTransactionDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="editDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="editDescription"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!-- Include jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var csrf_token = "{{ csrf_token() }}";

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                }
            }
        });

        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".delete-transaction").forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();

                    let transactionId = this.getAttribute("data-id");
                    let rowId = this.getAttribute("data-row-id");
                    let rowElement = document.getElementById(rowId);

                    if (confirm("Are you sure you want to delete this transaction?")) {
                        fetch(`/delete_transaction/${transactionId}`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": csrf_token
                            },
                            body: JSON.stringify({ transaction_id: transactionId })
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    rowElement.remove();  // Remove row instantly from the table
                                } else {
                                    alert("Error: " + data.message);
                                }
                            })
                            .catch(error => console.error("Fetch Error:", error));
                    }
                });
            });
            document.querySelectorAll(".edit-transaction").forEach(button => {
                button.addEventListener("click", function (event) {
                    event.preventDefault();
                    // Retrieve data attributes from the clicked element
                    let transactionId = this.getAttribute("data-id");
                    let amount = this.getAttribute("data-amount");
                    let transactionDate = this.getAttribute("data-date");
                    let description = this.getAttribute("data-description");

                    // Pre-fill modal fields
                    document.getElementById("editTransactionId").value = transactionId;
                    document.getElementById("editAmount").value = amount;
                    document.getElementById("editTransactionDate").value = transactionDate;
                    document.getElementById("editDescription").value = description;

                    // Show the modal using Bootstrap's modal API
                    let editModal = new bootstrap.Modal(document.getElementById("editTransactionModal"));
                    editModal.show();
                });
            });

            // Handle the modal form submission
            document.getElementById("editTransactionForm").addEventListener("submit", function (event) {
                event.preventDefault();
                let transactionId = document.getElementById("editTransactionId").value;
                let amount = document.getElementById("editAmount").value;
                let transactionDate = document.getElementById("editTransactionDate").value;
                let description = document.getElementById("editDescription").value;

                fetch(`/edit_transaction/${transactionId}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrf_token
                    },
                    body: JSON.stringify({
                        amount: amount,
                        transaction_date: transactionDate,
                        description: description
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Optionally, update the table row or simply reload the page
                            let modalEl = document.getElementById("editTransactionModal");
                            let modalInstance = bootstrap.Modal.getInstance(modalEl);
                            modalInstance.hide();
                            // For a quick fix, reload the page to reflect changes:
                            location.reload();
                        } else {
                            alert("Error: " + data.message);
                        }
                    })
                    .catch(error => console.error("Error updating transaction:", error));
            });
        });

        // Helper function to format a Date as a local YYYY-MM-DD string.
        function formatLocalDate(date) {
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            let day = date.getDate();
            return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        }

        function updateRangeDisplay() {
            const filterType = document.getElementById("filter").value;
            const dateInput = document.getElementById("date");
            const displayEl = document.getElementById("dateRangeDisplay");
            let currentDate = dateInput.value ? new Date(dateInput.value + "T00:00:00") : new Date();
            let startDate, endDate;

            if (filterType === "day") {
                startDate = new Date(currentDate);
                endDate = new Date(currentDate);
            } else if (filterType === "week") {
                let day = currentDate.getDay();
                let diffToMonday = (day === 0) ? -6 : (1 - day);
                startDate = new Date(currentDate);
                startDate.setDate(currentDate.getDate() + diffToMonday);
                endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + 6);
                dateInput.value = formatLocalDate(startDate);
            } else if (filterType === "month") {
                let parts = dateInput.value.split("-");
                let year = parseInt(parts[0]);
                let month = parseInt(parts[1]) - 1;
                startDate = new Date(year, month, 1);
                endDate = new Date(year, month + 1, 0);
                dateInput.value = formatLocalDate(startDate);
            } else if (filterType === "year") {
                let parts = dateInput.value.split("-");
                let year = parseInt(parts[0]);
                startDate = new Date(year, 0, 1);
                endDate = new Date(year, 11, 31);
                dateInput.value = formatLocalDate(startDate);
            }

            displayEl.textContent = `Showing transactions from ${formatLocalDate(startDate)} to ${formatLocalDate(endDate)}`;
        }

        function adjustDate(increment) {
            const filterType = document.getElementById("filter").value;
            const dateInput = document.getElementById("date");
            let currentDate = dateInput.value ? new Date(dateInput.value + "T00:00:00") : new Date();
            let baseDate;
            if (filterType === "day") {
                baseDate = new Date(currentDate);
                baseDate.setDate(baseDate.getDate() + increment);
            } else if (filterType === "week") {
                let day = currentDate.getDay();
                let diffToMonday = (day === 0) ? -6 : (1 - day);
                baseDate = new Date(currentDate);
                baseDate.setDate(currentDate.getDate() + diffToMonday);
                baseDate.setDate(baseDate.getDate() + (7 * increment));
            } else if (filterType === "month") {
                let parts = dateInput.value.split("-");
                let year = parseInt(parts[0]);
                let month = parseInt(parts[1]) - 1;
                baseDate = new Date(year, month, 1);
                baseDate.setMonth(baseDate.getMonth() + increment);
            } else if (filterType === "year") {
                let parts = dateInput.value.split("-");
                let year = parseInt(parts[0]);
                baseDate = new Date(year, 0, 1);
                baseDate.setFullYear(baseDate.getFullYear() + increment);
            }
            dateInput.value = formatLocalDate(baseDate);
            updateRangeDisplay();
        }

        document.getElementById("prevDate").addEventListener("click", function () {
            adjustDate(-1);
        });
        document.getElementById("nextDate").addEventListener("click", function () {
            adjustDate(1);
        });
        document.getElementById("date").addEventListener("change", updateRangeDisplay);
        document.getElementById("filter").addEventListener("change", updateRangeDisplay);
        updateRangeDisplay();
    </script>

</body>

</html>